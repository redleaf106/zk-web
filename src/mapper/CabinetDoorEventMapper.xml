<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="cn.org.bjca.zk.platform.dao.CabinetDoorEventDao">
	<resultMap id="CheckInfo" type="cn.org.bjca.zk.db.entity.CheckInfo">
		<id column="cabinetDoorNumber" property="cabinetDoorNumber" jdbcType="VARCHAR"/>
		<result column="departmentname" property="departmentName" jdbcType="VARCHAR"/>
		<result column="employeename" property="employeeName" jdbcType="VARCHAR"/>
		<result column="iccardnumber" property="icCardNumber" jdbcType="VARCHAR"/>
		<result column="employeenumber" property="employeeNumber" jdbcType="VARCHAR"/>
		<result column="dooropttime" property="doorOptTime" jdbcType="VARCHAR"/>
		<result column="status" property="doorOptStatus" jdbcType="VARCHAR"/>
		<result column="temporaryStatus" property="temporaryStatus" jdbcType="INTEGER"/>
		<result column="remark" property="remark" jdbcType="VARCHAR"/>
	</resultMap>


	<resultMap id="UrgentEvent" type="cn.org.bjca.zk.db.entity.UrgentEvent">
		<id column="id" property="id" jdbcType="INTEGER"/>
		<result column="employeeCardNumber" property="employeeCardNumber" jdbcType="VARCHAR"/>
		<result column="employeeName" property="employeeName" jdbcType="VARCHAR"/>
		<result column="doorOptTime" property="doorOptTime" jdbcType="VARCHAR"/>
		<result column="remark" property="remark" jdbcType="VARCHAR"/>
	</resultMap>
	<resultMap id="EventInfoResultMap" type="cn.org.bjca.zk.db.entity.EventInfo">
		<id column="id" property="id" jdbcType="VARCHAR"/>
		<result column="cabinetnumber" property="cabinetNumber" jdbcType="VARCHAR"/>
		<result column="cabinetpositiondetail" property="cabinetPositionDetail" jdbcType="VARCHAR"/>
		<result column="cabinetdoorname" property="cabinetDoorName" jdbcType="VARCHAR"/>
		<result column="employeename" property="employeeName" jdbcType="VARCHAR"/>
		<result column="status" property="status" jdbcType="VARCHAR"/>
		<result column="remark" property="remark" jdbcType="VARCHAR"/>
		<result column="dooropttime" property="doorOptTime" jdbcType="VARCHAR"/>
		<result column="picFilePath" property="picFilePath" jdbcType="VARCHAR"/>
		<result column="videoFilePath" property="videoFilePath" jdbcType="VARCHAR"/>
	</resultMap>
	<resultMap id="CabinetDoorEventMap" type="cn.org.bjca.zk.db.entity.CabinetDoorEvent">
		<id column="id" property="id" jdbcType="VARCHAR"/>
		<result column="cabinetdoorNumber" property="cabinetDoorNumber" jdbcType="VARCHAR"></result>
		<result column="cabinetNumber" property="cabinetNumber" jdbcType="VARCHAR"/>
		<result column="cabinetdoorname" property="cabinetdoorname" jdbcType="VARCHAR"/>
		<result column="employeecardnumber" property="employeeCardNumber" jdbcType="VARCHAR"/>
		<result column="dooropttime" property="doorOptTime" jdbcType="VARCHAR"/>
		<result column="status" property="status" jdbcType="VARCHAR"/>
		<result column="temporaryStatus" property="temporaryStatus" jdbcType="INTEGER"/>
		<result column="remark" property="remark" jdbcType="VARCHAR"/>
		<association property="employee" javaType="cn.org.bjca.zk.db.entity.Employee" column="employeecardnumber"  select="cn.org.bjca.zk.platform.dao.EmployeeDao.findByIcCardNumber"/>
		<association property="cabinet" javaType="cn.org.bjca.zk.db.entity.Cabinet" column="cabinetNumber"  select="cn.org.bjca.zk.platform.dao.CabinetDao.findByCabinetNumber"/>
	</resultMap>


	<!-- 分页查询 -->
	<select id="findPage" parameterType="cn.org.bjca.zk.platform.web.page.CabinetDoorEventPage" resultMap="CabinetDoorEventMap">
		SELECT
			BO_CABINETDOOREVENT.id,
		    BO_CABINETDOOREVENT.cabinetdoorNumber,
			BO_CABINETDOOREVENT.cabinetNumber,
			BO_CABINETDOOREVENT.employeecardnumber,
			BO_CABINETDOOREVENT.dooropttime,
			BO_CABINETDOOREVENT.status,
			BO_CABINETDOOREVENT.temporaryStatus,
			BO_CABINETDOOREVENT.remark,
		    bo_cabinetdoor.cabinetdoorname
		FROM BO_CABINETDOOREVENT,bo_employee,bo_cabinet,bo_cabinetdoor
		WHERE BO_CABINETDOOREVENT.employeecardnumber = bo_employee.iccardnumber
		and BO_CABINETDOOREVENT.cabinetNumber = bo_cabinet.cabinetnumber
		and bo_cabinetdoor.cabinetdoornumber = BO_CABINETDOOREVENT.cabinetdoorNumber
		and bo_cabinetdoor.cabinetid = bo_cabinet.id
		and bo_cabinetdoor.employeeid = bo_employee.id
		<if test="cabinetNumber != null">
			AND BO_CABINETDOOREVENT.CABINETNUMBER LIKE #{cabinetNumber}
		</if>
		<if test="cabinetdoorname != null">
			AND bo_cabinetdoor.cabinetdoorname LIKE #{cabinetdoorname}
		</if>
		<if test="cabinetDoorNumber != null">
			AND CABINETDOORNUMBER LIKE #{cabinetDoorNumber}
		</if>
		ORDER BY DOOROPTTIME DESC
	</select>
	<!-- 分页查询未推送的事件 -->
	<select id="findTemporaryPage" parameterType="cn.org.bjca.zk.platform.web.page.CabinetDoorEventPage" resultType="CabinetDoorEvent">
		SELECT *
		FROM BO_CABINETDOOREVENT
		WHERE 1=1 AND temporaryStatus = 1
		<if test="cabinetNumber != null">
			AND CABINETNUMBER LIKE #{cabinetNumber}
		</if>
		<if test="cabinetIp != null">
			AND CABINETIp LIKE #{cabinetIp}
		</if>
		<if test="cabinetDoorNumber != null">
			AND CABINETDOORNUMBER LIKE #{cabinetDoorNumber}
		</if>
		<if test="employeeCardNumber != null">
			AND EMPLOYEECARDNUMBER LIKE #{employeeCardNumber}
		</if>
		<if test="actionCardNumber != null">
			AND ACTIONCARDNUMBER LIKE #{actionCardNumber}
		</if>
		ORDER BY DOOROPTTIME DESC
	</select>

	<select id="findEventPage" resultType="java.util.Map" parameterType="cn.org.bjca.zk.platform.web.page.EventInfoPage">
		SELECT * FROM eventinfo ORDER BY DOOROPTTIME DESC
	</select>

	<!-- 保存数据 -->
	<insert id="save" parameterType="CabinetDoorEvent">
		INSERT INTO BO_CABINETDOOREVENT (
			ID, 
			CABINETIP,
			CABINETNUMBER,
			CABINETDOORNUMBER, 
			EMPLOYEECARDNUMBER,
			ACTIONCARDNUMBER,
			STATUS,
			TEMPORARYSTATUS,
			DOOROPTTIME,
			REMARK)
		VALUES (
			#{id}, 
			#{cabinetIp},
			#{cabinetNumber} ,
			#{cabinetDoorNumber}, 
			#{employeeCardNumber},
			#{actionCardNumber}, 
			#{status},
			#{temporaryStatus},
			#{doorOptTime},
			#{remark})
	</insert>

	<update id="send" parameterType="string">
		  UPDATE BO_CABINETDOOREVENT SET
		  TEMPORARYSTATUS = 0
		  WHERE ID = #{0}
	</update>

	<update id="sendAll">
		UPDATE BO_CABINETDOOREVENT SET TEMPORARYSTATUS = 0
	</update>

	<select id="findOneDay" resultType="CabinetDoorEvent" parameterType="string">
		SELECT
		bo_cabinetdoorevent.id as id,
		bo_cabinetdoorevent.opttime as optTime,
		bo_cabinetdoorevent.cabinetNumber as cabinetNumber,
		bo_cabinetdoorevent.cabinetIp as cabinetIp,
		bo_cabinetdoorevent.dooropttime as doorOptTime,
		bo_cabinetdoorevent.cabinetdoorNumber as cabinetDoorNumber,
		bo_cabinetdoorevent.`status`,
		bo_cabinetdoorevent.temporaryStatus as temporaryStatus,
		bo_cabinetdoorevent.remark as remark,
		bo_employee.employeeNumber as employeeCardNumber
		 FROM BO_CABINETDOOREVENT,BO_EMPLOYEE WHERE to_days(DOOROPTTIME) = to_days(#{date,jdbcType=DATE}) AND bo_cabinetdoorevent.employeecardnumber = bo_employee.iccardnumber
	</select>

	<select id="findOneEMPByOneDay" resultType="CabinetDoorEvent" parameterType="string">
		SELECT * FROM BO_CABINETDOOREVENT WHERE EMPLOYEECARDNUMBER = #{0} AND to_days(dooropttime) = to_days(#{1}) ORDER BY dooropttime DESC
	</select>

	<sql id="column_base">
		cabinetdoornumber,departmentname,employeename,employeeNumber,iccardnumber,DATE_FORMAT(dooropttime,'%H:%i:%s')as dooropttime,status,remark
	</sql>

	<select id="findDayInfo" resultMap="CheckInfo">
		select
		<include refid="column_base"/>
		from checkinfo where to_days(dooropttime) = to_days(#{0}) order by dooropttime ASC
	</select>

	<select id="test" resultType="java.util.Map">
		SELECT * FROM eventinfo
	</select>

	<sql id="eventBase">
		id,cabinetnumber,cabinetpositiondetail,cabinetdoorname,employeename,status,remark,dooropttime,picFilePath,videoFilePath
	</sql>

	<insert id="insertUrgentEvent" parameterType="UrgentEvent">
		insert into BO_URGENTEVENT(
		employeeCardNumber,
		employeeName,
		doorOptTime,
		remark,
		status
		) values (
		#{employeeCardNumber,jdbcType=VARCHAR},
		#{employeeName,jdbcType=VARCHAR},
		#{doorOptTime,jdbcType=VARCHAR},
		#{remark,jdbcType=VARCHAR},
		#{status,jdbcType=INTEGER}
		)
	</insert>

	<select id="getAllUnactivatedUrgentEvent" resultType="UrgentEvent">
		select * from BO_URGENTEVENT WHERE emailStatus = 0;
	</select>

	<update id="updateUrgentEventEmailStatus" parameterType="int">
		update BO_URGENTEVENT
		SET emailStatus=1
		where id = #{id}
	</update>

	<insert id="addPic">
		insert into BO_MONITOR(
		CABINETDOOREVENTID,
		PICFILEPATH
		) VALUES (
		#{0},
		#{1}
		)
	</insert>

    <update id="addVideo">
		update BO_MONITOR set
		VIDEOFILEPATH = {0}
		WHERE CABINETDOOREVENTID = #{1}
	</update>

	<select id="findAllNeedSend" resultType="CabinetDoorEvent">
		SELECT * FROM BO_CABINETDOOREVENT WHERE TEMPORARYSTATUS = 1;
	</select>

</mapper>
