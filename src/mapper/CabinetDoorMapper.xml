<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="cn.org.bjca.zk.platform.dao.CabinetDoorDao">

	<resultMap id="cabinetDoorMap" type="CabinetDoor">
        <result property="id" column="ID"/>
        <result property="cabinetDoorNumber" column="CABINETDOORNUMBER"/>
        <result property="employeeId" column="EMPLOYEEID"/>
        <result property="doorOptTime" column="DOOROPTTIME"/>
        <result property="accessCount" column="ACCESSCOUNT"/>
        <result property="status" column="STATUS"/>
        <result property="cabinetId" column="CABINETID"/>
        <result property="userId" column="USERID"/>
        <result property="optTime" column="OPTTIME"/>
        <result property="cabinetDoorName" column="CABINETDOORNAME"/>
        <result property="ext2" column="EXT2"/>
        <result property="ext3" column="EXT3"/>
        <association property="employee" javaType="cn.org.bjca.zk.db.entity.Employee" column="EMPLOYEEID"  select="cn.org.bjca.zk.platform.dao.EmployeeDao.findUniqueById"/>
        <association property="cabinet" javaType="cn.org.bjca.zk.db.entity.Cabinet" column="CABINETID"  select="cn.org.bjca.zk.platform.dao.CabinetDao.findUniqueById"/>
	</resultMap>

	<!-- 分页查询 -->
	<select id="findPage" parameterType="cn.org.bjca.zk.platform.web.page.CabinetDoorPage" resultMap="cabinetDoorMap">
		SELECT
		bo_cabinetdoor.id,
		bo_cabinetdoor.ext2,
		bo_cabinetdoor.ext3,
		bo_cabinetdoor.opttime,
		bo_cabinetdoor.cabinetdoornumber,
		bo_cabinetdoor.cabinetdoorname,
		bo_cabinetdoor.employeeid,
		bo_cabinetdoor.dooropttime,
		bo_cabinetdoor.accesscount,
		bo_cabinetdoor.`status`,
		bo_cabinetdoor.cabinetid,
		bo_cabinetdoor.userid
		FROM
		bo_cabinetdoor ,
		bo_employee
		WHERE 1=1
		AND bo_cabinetdoor.employeeid = bo_employee.id
		<if test="cabinetNumber != null">
			AND CABINETID IN (SELECT ID FROM BO_CABINET WHERE CABINETNUMBER LIKE #{cabinetNumber})
		</if>
		<if test="cabinetDoorNumber != null">
			AND CABINETDOORNUMBER LIKE #{cabinetDoorNumber}
		</if>
		<if test="employeeName != null">
			AND EMPLOYEEID IN (SELECT ID FROM BO_EMPLOYEE WHERE EMPLOYEENAME LIKE #{employeeName})
		</if>
		ORDER BY bo_employee.employeenumber ASC
	</select>

	<select id="findPageyrdg" parameterType="cn.org.bjca.zk.platform.web.page.CabinetDoorPage" resultMap="cabinetDoorMap">
		SELECT
		bo_cabinetdoor.id,
		bo_cabinetdoor.ext2,
		bo_cabinetdoor.ext3,
		bo_cabinetdoor.opttime,
		bo_cabinetdoor.cabinetdoornumber,
		bo_cabinetdoor.cabinetdoorname,
		bo_cabinetdoor.employeeid,
		bo_cabinetdoor.dooropttime,
		bo_cabinetdoor.accesscount,
		bo_cabinetdoor.`status`,
		bo_cabinetdoor.cabinetid,
		bo_cabinetdoor.userid
		from bo_cabinetdoor ,
		bo_employee
		where employeeid IN
		(select employeeid from BO_CABINETDOOR GROUP BY employeeid HAVING count(1)>1)
		AND bo_cabinetdoor.employeeid = bo_employee.id
		ORDER BY bo_employee.employeenumber ASC
	</select>
	<select id="findCEByCabinetID" parameterType="String" resultMap="cabinetDoorMap">
		select
		   bo_cabinetdoor.id,
		   bo_cabinetdoor.ext2,
		   bo_cabinetdoor.cabinetdoorname,
		   bo_cabinetdoor.employeeid
		from bo_cabinetdoor,bo_employee
		where bo_cabinetdoor.cabinetid=#{cabinetId} and bo_cabinetdoor.employeeid = bo_employee.id
	</select>
	<!-- 保存数据 -->
	<insert id="save" parameterType="CabinetDoor">
		INSERT INTO BO_CABINETDOOR (
			ID, 
			CABINETDOORNUMBER,
			CABINETDOORNAME,
			CABINETID, 
			EMPLOYEEID, 
			USERID,
			OPTTIME)
		VALUES (
			#{id}, 
			#{cabinetDoorNumber},
			#{cabinetDoorName},
			#{cabinetId}, 
			#{employeeId}, 
			#{userId}, 
			#{optTime})
	</insert>
	
	<update id="saveCabinetImg" parameterType="String">
		update BO_CABINET set ext2 = #{1} where id = #{0}
	</update>
	<!-- 更新数据 -->
	<update id="update" parameterType="CabinetDoor">
		UPDATE BO_CABINETDOOR SET
		<if test="cabinetDoorName!=null">
			CABINETDOORNAME = #{cabinetDoorName},
		</if>
			DOOROPTTIME=null,
        	ACCESSCOUNT = 0,
        	`STATUS` = #{status},
			USERID = #{userId},
			DOOROPTTIME = #{doorOptTime},
			OPTTIME = #{optTime}
        WHERE 
	        ID = #{id} 
	</update>
	
	<select id="findByCondition" resultType="CabinetDoor">
		select * from BO_CABINETDOOR where 1=1
		<if test="null!=cabinetDoorNumber">
			  AND CABINETDOORNUMBER = #{cabinetDoorNumber}
		</if>
		<if test="null!=cabinetDoorName">
			AND CABINETDOORNAME = #{cabinetDoorName}
		</if>
		<if test="null!=cabinetIp or null != cabinetNumber">
	       AND CABINETID in  (SELECT ID FROM BO_CABINET WHERE 1=1
	       	<if test="null!=cabinetIp ">
	       		AND CABINETIP = #{cabinetIp}
	       </if>
	       <if test="null != cabinetNumber or null != cabinetNumber">
	       		AND CABINETNUMBER = #{cabinetNumber}
	       </if>
	       )
		</if>
		
	</select>

	<select id="selectDoorByCabinetIdAndCabinetDoorNumber" resultMap="cabinetDoorMap" parameterType="string">
		SELECT * FROM BO_CABINETDOOR WHERE cabinetid = #{0} AND cabinetdoornumber = #{1}
	</select>

	<select id="findUniqueById" resultMap="cabinetDoorMap">
		SELECT * FROM BO_CABINETDOOR WHERE id = #{id}
	</select>
</mapper> 
